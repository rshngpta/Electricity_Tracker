<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Smart Electricity Tracker</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
      input, button, select { padding: 8px; font-size: 14px; margin: 4px 6px 4px 0; }
      .section { margin-bottom: 24px; }
      table { border-collapse: collapse; width: 100%; margin-top: 12px; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      .small { font-size: 13px; color: #555; }
    </style>
  </head>
  <body>
    <h1>Smart Electricity Tracker</h1>

    <div class="section">
      <h3>Upload CSV</h3>
      <form id="uploadForm">
        <input type="file" id="fileInput" name="file" accept=".csv" />
        <button type="submit">Upload</button>
      </form>
      <div id="uploadResult" class="small"></div>
    </div>

    <div class="section">
      <h3>View Usage / Estimate</h3>
      <div>
        <label>Device ID: <input type="text" id="deviceId" value="device-001" /></label>
      </div>

      <div style="margin-top:8px;">
        <button id="viewUsage">Get Usage</button>
        <button id="getEstimate">Estimate Bill</button>
        <input id="rateInput" type="number" step="0.01" value="0.20" style="width:100px" /> EUR/kWh
      </div>

      <div id="usageResult" style="margin-top:12px;"></div>
      <div id="estimateResult" style="margin-top:12px;"></div>
    </div>

    <script>
      // Upload handler
      const uploadForm = document.getElementById('uploadForm');
      const uploadResult = document.getElementById('uploadResult');
      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) {
          uploadResult.textContent = "Please choose a CSV file.";
          return;
        }
        const file = fileInput.files[0];
        const fd = new FormData();
        fd.append('file', file);
        uploadResult.textContent = "Uploading...";
        try {
          const res = await fetch('/upload', { method: 'POST', body: fd });
          const json = await res.json();
          if (!res.ok) {
            uploadResult.innerHTML = "<b>Error:</b> " + (json.error || JSON.stringify(json));
          } else {
            uploadResult.innerHTML = "<b>Uploaded.</b> ID: " + json.upload_id + ", processed: " + json.processed_count;
          }
        } catch (err) {
          uploadResult.textContent = "Upload failed: " + err;
        }
      });

      // Usage display
      document.getElementById('viewUsage').addEventListener('click', async () => {
        const deviceId = document.getElementById('deviceId').value;
        if (!deviceId) {
          document.getElementById('usageResult').textContent = "Device ID required.";
          return;
        }
        let url = `/usage?device_id=${encodeURIComponent(deviceId)}&period=day`;
        document.getElementById('usageResult').textContent = "Loading usage...";
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (!res.ok) {
            document.getElementById('usageResult').textContent = "Error: " + (json.error || JSON.stringify(json));
            return;
          }
          const data = json.data || [];
          if (!data.length) {
            document.getElementById('usageResult').innerHTML = "<i>No data</i>";
            return;
          }
          let html = "<table><tr><th>Period</th><th>Total kWh</th></tr>";
          for (const row of data) {
            html += `<tr><td>${row.period}</td><td>${row.total_kwh}</td></tr>`;
          }
          html += "</table>";
          document.getElementById('usageResult').innerHTML = html;
        } catch (err) {
          document.getElementById('usageResult').textContent = "Failed: " + err;
        }
      });

      // Estimate handler
      document.getElementById('getEstimate').addEventListener('click', async () => {
        const deviceId = document.getElementById('deviceId').value;
        const rate = document.getElementById('rateInput').value || "0.20";
        if (!deviceId) {
          document.getElementById('estimateResult').textContent = "Device ID required.";
          return;
        }
        const url = `/estimate?device_id=${encodeURIComponent(deviceId)}&period=day&rate=${encodeURIComponent(rate)}`;
        document.getElementById('estimateResult').textContent = "Calculating...";
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (!res.ok) {
            document.getElementById('estimateResult').textContent = "Error: " + (json.error || JSON.stringify(json));
            return;
          }
          document.getElementById('estimateResult').innerHTML = `<b>Estimated cost:</b> ${json.estimated_cost} ${json.currency} (rate ${json.rate_per_kwh} per kWh)`;
        } catch (err) {
          document.getElementById('estimateResult').textContent = "Failed: " + err;
        }
      });
    </script>
  </body>
</html>
